rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Helper
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * (A) PC ì—°ë™ í‚¤ ê²€ì¦ìš© â€” ì„œë²„ ì „ìš©
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /deviceSecretsByHash/{hash} {
      allow read, write: if false;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * (B) ì‚¬ìš©ì ë¬¸ì„œ
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /users/{uid} {

      // ğŸ”¹ ë³¸ì¸ë§Œ ì½ê¸° ê°€ëŠ¥ (PCì—ì„œ tokenVersion ì½ê¸° í•„ìš”)
      allow read: if isOwner(uid);

      // ğŸ”¹ create: ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ í”„ë¡œí•„ ìƒì„± í—ˆìš©
      allow create: if isOwner(uid);

      // ğŸ”¹ update: "í”„ë¡œí•„ í•„ë“œë§Œ" í—ˆìš©
      allow update: if isOwner(uid)
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly([
            'displayName',
            'photoURL',
            'updatedAt'
          ]);

      // âŒ deleteëŠ” ê¸ˆì§€
      allow delete: if false;

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       * (C) ì—°ê²°ëœ PC ëª©ë¡
       * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      match /devices/{deviceId} {

        // ë³¸ì¸ë§Œ ì½ê¸°
        allow read: if isOwner(uid);

        // âŒ ìƒì„±/ì‚­ì œëŠ” ì„œë²„(Function)ë§Œ
        allow create, delete: if false;

        // ğŸ”¹ í´ë¼ëŠ” nicknameë§Œ ìˆ˜ì • ê°€ëŠ¥
        allow update: if isOwner(uid)
          && request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(['nickname'])
          && request.resource.data.nickname is string
          && request.resource.data.nickname.size() <= 30;
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ê·¸ ì™¸ ì „ë¶€ ì°¨ë‹¨
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
